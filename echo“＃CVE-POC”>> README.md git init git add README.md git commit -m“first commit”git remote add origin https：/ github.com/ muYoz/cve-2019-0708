# _*_ coding: utf-8 _*_

"""
auth: zhangdaoyuan@BG
function: cve-2019-0708漏洞检测
note: 借助于poc做检测, 3389_hosts为IP地址清单，0708detector.exe为poc
"""

import os
import subprocess
from multiprocessing.dummy import Pool as ThreadPool

current_abs_path = os.path.abspath(__file__)
current_abs_path_dir = os.path.dirname(current_abs_path)
poc = os.path.abspath(current_abs_path_dir) + '/0708detector.exe'


def cve_2019_0708(ip):
    try:
        port = '3389'
        command = poc + ' -t ' + ip + ' -p ' + port
        result = subprocess.Popen(args=command,stdout=subprocess.PIPE)
        result.wait()
        res = result.stdout.read()

        if 'WARNING: SERVER IS VULNERABLE' in res:
            res1 = u'%s 存在CVE-2019-0708漏洞!!!!!' % ip
            print(res1)

    except Exception, e:
        pass

if __name__ == '__main__':
    rdp_hosts = []
    with open('3389_hosts.txt', 'r') as f:#将 windows 平台的IP放入3389_hosts.txt
        data = f.readlines()
        for x in data:
            ip = x.strip()
            rdp_hosts.append(ip)

    pool = ThreadPool(10)
    pool.map(cve_2019_0708, rdp_hosts)
